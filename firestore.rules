rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get user role from Firestore
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role == role;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isDispatcher() {
      return hasRole('dispatcher');
    }
    
    function isParamedic() {
      return hasRole('paramedic');
    }
    
    function isHospitalAdmin() {
      return hasRole('hospital_admin');
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAmbulanceDriver() {
      return hasRole('ambulance_driver');
    }

    // ============================================
    // Emergency Cases Collection
    // - paramedic: create
    // - dispatcher: read/update
    // - admin: full access
    // ============================================
    match /emergencyCases/{caseId} {
      allow read: if isAuthenticated() && (isParamedic() || isDispatcher() || isAdmin());
      allow create: if isAuthenticated() && (isParamedic() || isDispatcher() || isAdmin());
      allow update: if isAuthenticated() && (isDispatcher() || isAdmin());
      allow delete: if isAdmin();
    }

    // ============================================
    // Hospitals Collection
    // - hospital_admin: create own, update own (adminId == uid)
    // - dispatcher: read only
    // - admin: full access
    // ============================================
    match /hospitals/{hospitalId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (isHospitalAdmin() || isAdmin());
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isHospitalAdmin() && resource.data.adminId == request.auth.uid)
      );
      allow delete: if isAdmin();
    }

    // ============================================
    // Dispatch Overrides Collection (audit trail)
    // ============================================
    match /dispatchOverrides/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (isDispatcher() || isAdmin() || getUserData().role == 'command_center');
    }

    // ============================================
    // Ambulance Tracking Collection (live GPS)
    // - all authenticated: read (for shareable links)
    // - dispatcher/paramedic/admin/command_center: write
    // ============================================
    match /ambulanceTracking/{trackingId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
    }

    // ============================================
    // Ambulances Collection
    // - ambulance_driver: create own (driverId == uid), read own, update own ONLY if pending
    // - dispatcher: read all, update
    // - admin: full access (including verification status changes)
    // ============================================
    match /ambulances/{ambulanceId} {
      allow read: if isAuthenticated() && (
        isAdmin() || isDispatcher() || getUserData().role == 'command_center' ||
        isParamedic() ||
        (isAmbulanceDriver() && resource.data.driverId == request.auth.uid)
      );
      allow create: if isAuthenticated() && (
        isAdmin() ||
        (isAmbulanceDriver() && request.resource.data.driverId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        isDispatcher() || isAdmin() ||
        (isAmbulanceDriver() && resource.data.driverId == request.auth.uid
          && resource.data.verificationStatus == 'pending')
      );
      allow delete: if isAdmin();
    }

    // ============================================
    // Users Collection
    // - self: read own document
    // - admin: full access
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || request.auth.uid == userId;
    }

    // ============================================
    // Feedback Collection
    // - authenticated: create
    // - admin: read all
    // ============================================
    // Communication Logs Collection
    // ============================================
    match /communicationLogs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ============================================
    match /feedback/{docId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ============================================
    // Reports Collection (legacy support)
    // ============================================
    match /reports/{reportId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ============================================
    // Alerts Collection (legacy support)
    // ============================================
    match /alerts/{alertId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

  }
}
